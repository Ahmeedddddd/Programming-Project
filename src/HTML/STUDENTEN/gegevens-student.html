<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Gegevens</title>
    <link rel="stylesheet" href="/src/CSS/style.css">
    <link rel="stylesheet" href="/src/CSS/STUDENTEN/gegevens-student.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/js/navigation-manager.js"></script>
    <script src="/js/role-manager.js"></script>
</head>

<body>
    <div class="container">
        <div class="nav">
            <div class="logo">
                <img src="/images/image.png" alt="Erasmus Logo" class="logo" />
            </div>
            <div class="navBar">

            </div>
            <div class="pfpContainer">
                <img src="/images/mystery man avatar.webp" alt="Profiel" class="profile-pic" id="burgerToggle" />
            </div>
        </div>

        <div class="sideMenu" id="sideMenu">
            <div class="menu-bg-animation"></div>
            <div class="menu-bg-animation"></div>
            <div class="sparkles"></div>

            <div class="sideMenu-header">
                <div>
                    <h2 class="sideMenu-title">CareerLaunch EHB</h2>
                    <p class="sideMenu-subtitle">Menu</p>
                </div>
                <button class="sideMenu-closeBtn" onclick="toggleMenu()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sideMenu-content">
                <!-- Dynamically populated -->
            </div>
        </div>

        <main class="flex-center">
            <div class="contentKaart animatie-fade-up">

                <div class="text-center mb-3">
                    <span class="ehbBadge student">Student Account</span>
                </div>

                <form id="studentForm" class="w-full">

                    <div class="ehbSectieHeader" style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">üë§ Persoonlijke Gegevens</h3>
                    </div>

                    <div class="ehbVeld mb-2" data-field="studentnummer">
                        <strong>Studentnummer:</strong> <span class="field-value">Laden...</span>
                    </div>

                    <div class="ehbGrid tweekolomnig mb-2">
                        <div class="ehbVeld mb-2" data-field="voornaam">
                            <strong>Voornaam:</strong>
                            <span class="field-value">Laden...</span>
                        </div>
                        <div class="ehbVeld mb-2" data-field="achternaam">
                            <strong>Achternaam:</strong> <span class="field-value">Laden...</span>
                        </div>
                    </div>

                    <div class="ehbSectieHeader" style="margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">üìû Contact Informatie</h3>
                    </div>

                    <div class="ehbGrid tweekolomnig mb-2">
                        <div class="ehbVeld email editable-field" data-field="email">
                            <strong>Email:</strong> <span class="field-value display-mode">Laden...</span> <input
                                type="text" id="edit-email" class="edit-input edit-mode" style="display: none;">
                        </div>
                        <div class="ehbVeld telefoon editable-field" data-field="telefoon">
                            <strong>Telefoon:</strong> <span class="field-value display-mode">Laden...</span> <input
                                type="text" id="edit-telefoon" class="edit-input edit-mode" style="display: none;">
                        </div>
                    </div>

                    <div class="ehbSectieHeader" style="margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">üéì Studie Informatie</h3>
                    </div>

                    <div class="ehbGrid tweekolomnig mb-2">
                        <div class="ehbVeld editable-field" data-field="opleiding">
                            <strong>Opleiding:</strong> <span class="field-value display-mode">Laden...</span> <input
                                type="text" id="edit-opleiding" class="edit-input edit-mode" style="display: none;">
                        </div>
                        <div class="ehbVeld editable-field" data-field="opleidingsrichting">
                            <strong>Opleidingsrichting:</strong> <span class="field-value display-mode">Laden...</span>
                            <input type="text" id="edit-opleidingsrichting" class="edit-input edit-mode"
                                style="display: none;">
                        </div>
                    </div>
                    <div class="ehbVeld mb-2" data-field="leerjaar"> <strong>Leerjaar:</strong> <span
                            class="field-value">Laden...</span>
                    </div>
                    <div class="ehbVeld mb-2" data-field="academiejaar">
                        <strong>Academiejaar:</strong> <span class="field-value">2024-2025</span>
                    </div>

                    <div class="ehbSectieHeader" style="margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">üíº Project Informatie</h3>
                    </div>

                    <div class="ehbVeld mb-2 editable-field" data-field="project-titel">
                        <strong>Project Titel:</strong> <span class="field-value display-mode">Laden...</span> <input
                            type="text" id="edit-project-titel" class="edit-input edit-mode" style="display: none;">
                    </div>
                    <div class="ehbVeld mb-2" data-field="tafel-nummer"> <strong>Tafel Nummer:</strong> <span
                            class="field-value">Laden...</span>
                    </div>

                    <div class="ehbVeld mb-2 editable-field" data-field="project-beschrijving"
                        style="min-height: 100px; padding: 1.5rem;">
                        <strong>Project Beschrijving:</strong><br><br>
                        <span class="field-value display-mode">Laden...</span> <textarea id="edit-project-beschrijving"
                            class="project-edit-input edit-mode" rows="6" style="display: none;"></textarea>
                    </div>

                    <div class="ehbVeld mb-2 editable-field" data-field="over-mezelf"
                        style="min-height: 100px; padding: 1.5rem;">
                        <strong>Over Mezelf:</strong><br><br>
                        <span class="field-value display-mode">Laden...</span> <input type="text" id="edit-over-mezelf"
                            class="edit-input edit-mode" style="display: none;">
                    </div>

                    <div class="ehbSectieHeader" style="margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">üîó Project Links</h3>
                    </div>

                    <div class="ehbGrid tweekolomnig mb-2">
                        <div class="ehbVeld editable-field" data-field="github-url" id="github-link">
                            <strong>GitHub:</strong> <span class="field-value display-mode">Laden...</span> <input
                                type="text" id="edit-github-url" class="edit-input edit-mode" style="display: none;">
                        </div>
                        <div class="ehbVeld editable-field" data-field="linkedin-url" id="linkedin-link">
                            <strong>LinkedIn:</strong> <span class="field-value display-mode">Laden...</span> <input
                                type="text" id="edit-linkedin-url" class="edit-input edit-mode" style="display: none;">
                        </div>
                    </div>
                    <div class="ehbVeld mb-2 editable-field" data-field="cv-url" id="cv-link">
                        <strong>CV:</strong> <span class="field-value display-mode">Laden...</span> <input type="text"
                            id="edit-cv-url" class="edit-input edit-mode" style="display: none;">
                    </div>

                    <div class="ehbSectieHeader" style="margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">üìà Project Status</h3>
                    </div>
                    <div class="ehbVeld mb-2">
                        <strong>Voortgang:</strong>
                        <div class="progress-bar-container"
                            style="background-color: #e0e0e0; border-radius: 5px; height: 20px; margin-top: 5px;">
                            <div id="project-progress" class="progress-bar"
                                style="background: linear-gradient(90deg, #881538, #A91B47); height: 100%; width: 0%; border-radius: 5px; text-align: center; color: white; line-height: 20px; transition: width 0.5s ease-in-out;">
                                0% compleet
                            </div>
                        </div>
                    </div>


                    <div class="ehbSectieHeader" style="margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">üìç Adres Informatie</h3>
                    </div>

                    <div class="ehbGrid tweekolomnig mb-2">
                        <div class="ehbVeld editable-field" data-field="straatnaam">
                            <strong>Straatnaam:</strong> <span class="field-value display-mode">Laden...</span> <input
                                type="text" id="edit-straatnaam" class="edit-input edit-mode" style="display: none;">
                        </div>
                        <div class="ehbVeld editable-field" data-field="huisnummer">
                            <strong>Huisnummer:</strong> <span class="field-value display-mode">Laden...</span> <input
                                type="text" id="edit-huisnummer" class="edit-input edit-mode" style="display: none;">
                        </div>
                    </div>

                    <div class="ehbGrid tweekolomnig mb-2">
                        <div class="ehbVeld editable-field" data-field="bus">
                            <strong>Bus:</strong> <span class="field-value display-mode">Laden...</span> <input
                                type="text" id="edit-bus" class="edit-input edit-mode" style="display: none;">
                        </div>
                        <div class="ehbVeld editable-field" data-field="postcode">
                            <strong>Postcode:</strong> <span class="field-value display-mode">Laden...</span> <input
                                type="text" id="edit-postcode" class="edit-input edit-mode" style="display: none;">
                        </div>
                    </div>

                    <div class="ehbVeld mb-2 editable-field" data-field="gemeente">
                        <strong>Gemeente:</strong> <span class="field-value display-mode">Laden...</span> <input
                            type="text" id="edit-gemeente" class="edit-input edit-mode" style="display: none;">
                    </div>

                    <div class="ehbSectieHeader" style="margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">üîí Beveiliging</h3>
                    </div>

                    <div class="ehbVeld mb-2">
                        <strong>Wachtwoord:</strong> ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
                    </div>

                    <div class="ehbVeld" data-field="last-login">
                        <strong>Laatste login:</strong> <span class="field-value">Laden...</span>
                    </div>

                </form>

                <div id="viewControls" class="flex-center mt-4" style="gap: 1rem; flex-wrap: wrap;">
                    <button id="editBtn" class="ehbBtn bewerken">
                        <i class="fas fa-pencil-alt"></i>
                        Gegevens Bewerken
                    </button>
                    <button id="projectEditBtn" class="ehbBtn bewerken"
                        style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                        <i class="fas fa-edit"></i>
                        Project Bewerken
                    </button>
                    <button class="ehbBtn secundair" onclick="openPasswordModal()">
                        <i class="fas fa-key"></i>
                        Wachtwoord Wijzigen
                    </button>
                    <button class="ehbBtn" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);">
                        <i class="fas fa-download"></i>
                        CV Downloaden
                    </button>
                </div>

                <div id="editControls" class="flex-center mt-4" style="gap: 1rem; flex-wrap: wrap; display: none;">
                    <button type="button" id="saveGeneralBtn" class="ehbBtn primair"> <i class="fas fa-save"></i>
                        Bewaren
                    </button>
                    <button type="button" id="cancelBtn" class="ehbBtn secundair">
                        <i class="fas fa-times"></i>
                        Annuleren
                    </button>
                </div>

                <div id="projectEditControls" class="flex-center mt-4"
                    style="gap: 1rem; flex-wrap: wrap; display: none;">
                    <button type="button" id="projectSaveBtn" class="ehbBtn primair"
                        style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                        <i class="fas fa-save"></i>
                        Project Bewaren
                    </button>
                    <button type="button" id="projectCancelBtn" class="ehbBtn secundair">
                        <i class="fas fa-times"></i>
                        Annuleren Project
                    </button>
                </div>


                <div class="text-center mt-4">
                    <div class="ehbVeld" data-field="account-status"
                        style="background: rgba(34, 197, 94, 0.1); border-color: #22c55e; color: #15803d;">
                        <i class="fas fa-check-circle"></i>
                        <strong>Account Status:</strong> <span class="field-value">Laden...</span>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <p style="color: #666; font-size: 0.9rem;">
                        <span id="account-created">Account aangemaakt: Laden...</span><br>
                        <span id="last-updated">Laatste update: Laden...</span>
                    </p>
                </div>

            </div>
        </main>

        <div class="menu-overlay"></div>

    </div>

    <div id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <div id="notification-container" style="
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 10000;
    "></div>

    <div id="passwordModal" class="password-modal">
        <div class="password-modal-content">
            <div class="password-modal-header">
                <h2 class="password-modal-title">
                    <i class="fas fa-key"></i>
                    Wachtwoord Wijzigen
                </h2>
                <button class="password-modal-close" onclick="closePasswordModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="password-modal-body">
                <div id="modalMessage"></div>

                <div class="help-text">
                    <i class="fas fa-info-circle"></i>
                    Kies een sterk wachtwoord dat voldoet aan alle beveiligingseisen hieronder.
                </div>

                <form id="passwordChangeForm">
                    <div class="password-form-group">
                        <label for="currentPassword">Huidig Wachtwoord *</label>
                        <div class="password-input-container">
                            <input type="password" id="currentPassword" name="currentPassword" required
                                placeholder="Voer je huidige wachtwoord in" autocomplete="current-password">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('currentPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="password-form-group">
                        <label for="newPassword">Nieuw Wachtwoord *</label>
                        <div class="password-input-container">
                            <input type="password" id="newPassword" name="newPassword" required
                                placeholder="Voer je nieuwe wachtwoord in" autocomplete="new-password">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('newPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>

                        <div id="passwordStrengthMeter" class="password-strength-meter" style="display: none;">
                            <div class="strength-text" id="strengthText">Wachtwoord sterkte: Zwak</div>
                            <div class="strength-bar">
                                <div id="strengthBar" class="strength-fill" style="width: 0%;"></div>
                            </div>
                            <ul id="strengthRequirements" class="strength-requirements">
                                <li id="req-length" class="invalid">
                                    <span class="requirement-icon invalid">‚úó</span>
                                    Minimaal 8 karakters
                                </li>
                                <li id="req-uppercase" class="invalid">
                                    <span class="requirement-icon invalid">‚úó</span>
                                    Minimaal 1 hoofdletter (A-Z)
                                </li>
                                <li id="req-lowercase" class="invalid">
                                    <span class="requirement-icon invalid">‚úó</span>
                                    Minimaal 1 kleine letter (a-z)
                                </li>
                                <li id="req-number" class="invalid">
                                    <span class="requirement-icon invalid">‚úó</span>
                                    Minimaal 1 cijfer (0-9)
                                </li>
                                <li id="req-special" class="invalid">
                                    <span class="requirement-icon invalid">‚úó</span>
                                    Minimaal 1 speciaal teken (!@#$%^&*)
                                </li>
                                <li id="req-patterns" class="invalid">
                                    <span class="requirement-icon invalid">‚úó</span>
                                    Geen veelgebruikte patronen
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="password-form-group">
                        <label for="confirmPassword">Bevestig Nieuw Wachtwoord *</label>
                        <div class="password-input-container">
                            <input type="password" id="confirmPassword" name="confirmPassword" required
                                placeholder="Bevestig je nieuwe wachtwoord" autocomplete="new-password">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('confirmPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </form>

                <div class="password-modal-actions">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closePasswordModal()">
                        <i class="fas fa-times"></i>
                        Annuleren
                    </button>
                    <button type="button" id="savePasswordBtn" class="modal-btn modal-btn-primary" disabled>
                        <i class="fas fa-save"></i>
                        Wachtwoord Opslaan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === INLINE FIXED PASSWORD MODAL JAVASCRIPT ===
        // üîê GEFIXTE PASSWORD MODAL VOOR EHB SYSTEEM

        console.log('üîê Loading Fixed Password Modal...');

        // === GLOBAL VARIABLES ===
        window.currentPasswordUser = null;
        window.passwordRequirements = {
            minLength: false,
            hasUppercase: false,
            hasLowercase: false,
            hasNumbers: false,
            hasSpecialChars: false,
            noCommonPatterns: false
        };

        // === MODAL FUNCTIONS (GLOBAL SCOPE) ===
        window.openPasswordModal = function () {
            console.log('üîê Opening password modal...');

            const modal = document.getElementById('passwordModal');
            if (!modal) {
                console.error('‚ùå Password modal not found! Make sure the HTML is added.');
                return;
            }

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Get current user info
            getCurrentPasswordUser();

            // Focus on first input
            setTimeout(() => {
                const firstInput = document.getElementById('currentPassword');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 100);

            console.log('‚úÖ Password modal opened successfully');
        };

        window.closePasswordModal = function () {
            console.log('üîê Closing password modal...');

            const modal = document.getElementById('passwordModal');
            if (modal) {
                modal.style.display = 'none';
            }
            document.body.style.overflow = 'auto';

            // Reset form
            const form = document.getElementById('passwordChangeForm');
            if (form) {
                form.reset();
            }

            const messageContainer = document.getElementById('modalMessage');
            if (messageContainer) {
                messageContainer.innerHTML = '';
            }

            const strengthMeter = document.getElementById('passwordStrengthMeter');
            if (strengthMeter) {
                strengthMeter.style.display = 'none';
            }

            const saveBtn = document.getElementById('savePasswordBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
            }

            // Reset requirements
            resetPasswordRequirements();

            console.log('‚úÖ Password modal closed successfully');
        };

        // === PASSWORD VISIBILITY TOGGLE ===
        window.togglePasswordVisibility = function (inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;

            const button = input.nextElementSibling;
            if (!button) return;

            const icon = button.querySelector('i');
            if (!icon) return;

            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        };

        // === PASSWORD STRENGTH VALIDATION ===
        function validatePasswordStrength(password) {
            const requirements = {
                minLength: password.length >= 8,
                hasUppercase: /[A-Z]/.test(password),
                hasLowercase: /[a-z]/.test(password),
                hasNumbers: /\d/.test(password),
                hasSpecialChars: /[!@#$%^&*(),.?":{}|<>]/.test(password),
                noCommonPatterns: !/^(password|123456|qwerty|admin|welcome|login|changeme)$/i.test(password)
            };

            const score = Object.values(requirements).filter(Boolean).length;
            const isValid = score >= 6 && requirements.minLength;

            return {
                requirements,
                score,
                maxScore: 6,
                isValid,
                level: getSecurityLevel(score),
                message: getSecurityMessage(score)
            };
        }

        function getSecurityLevel(score) {
            if (score >= 6) return 'maximum';
            if (score >= 5) return 'strong';
            if (score >= 3) return 'medium';
            return 'weak';
        }

        function getSecurityMessage(score) {
            if (score >= 6) return 'Uitstekend - Maximale beveiliging';
            if (score >= 5) return 'Sterk - Goede beveiliging';
            if (score >= 3) return 'Gemiddeld - Kan beter';
            return 'Zwak - Niet veilig genoeg';
        }

        function updatePasswordStrength(password) {
            const meter = document.getElementById('passwordStrengthMeter');

            if (!password) {
                if (meter) meter.style.display = 'none';
                return false;
            }

            if (meter) meter.style.display = 'block';

            const validation = validatePasswordStrength(password);
            const { requirements, score, level, message } = validation;

            // Update progress bar
            const progressBar = document.getElementById('strengthBar');
            const progressText = document.getElementById('strengthText');

            if (progressBar && progressText) {
                const percentage = (score / 6) * 100;
                progressBar.style.width = percentage + '%';
                progressBar.className = `strength-fill strength-${level}`;
                progressText.textContent = `Wachtwoord sterkte: ${message}`;
            }

            // Update requirements list
            updateRequirement('req-length', requirements.minLength);
            updateRequirement('req-uppercase', requirements.hasUppercase);
            updateRequirement('req-lowercase', requirements.hasLowercase);
            updateRequirement('req-number', requirements.hasNumbers);
            updateRequirement('req-special', requirements.hasSpecialChars);
            updateRequirement('req-patterns', requirements.noCommonPatterns);

            // Store global requirements
            window.passwordRequirements = requirements;

            return validation.isValid;
        }

        function updateRequirement(elementId, isValid) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const icon = element.querySelector('.requirement-icon');
            if (!icon) return;

            if (isValid) {
                element.className = 'valid';
                icon.className = 'requirement-icon valid';
                icon.textContent = '‚úì';
            } else {
                element.className = 'invalid';
                icon.className = 'requirement-icon invalid';
                icon.textContent = '‚úó';
            }
        }

        function resetPasswordRequirements() {
            const requirements = ['req-length', 'req-uppercase', 'req-lowercase', 'req-number', 'req-special', 'req-patterns'];
            requirements.forEach(req => updateRequirement(req, false));
        }

        // === FORM VALIDATION ===
        function validatePasswordForm() {
            const currentPassword = document.getElementById('currentPassword')?.value || '';
            const newPassword = document.getElementById('newPassword')?.value || '';
            const confirmPassword = document.getElementById('confirmPassword')?.value || '';

            const hasCurrentPassword = currentPassword.length > 0;
            const hasValidNewPassword = updatePasswordStrength(newPassword);
            const passwordsMatch = newPassword === confirmPassword && newPassword.length > 0;

            const isValid = hasCurrentPassword && hasValidNewPassword && passwordsMatch;

            const saveBtn = document.getElementById('savePasswordBtn');
            if (saveBtn) {
                saveBtn.disabled = !isValid;
            }

            return isValid;
        }

        // === USER MANAGEMENT ===
        function getCurrentPasswordUser() {
            try {
                // Try multiple sources for user data
                window.currentPasswordUser = {
                    gebruikersId: sessionStorage.getItem('gebruikersId') ||
                        localStorage.getItem('gebruikersId') ||
                        window.gebruikersId ||
                        'demo-user',
                    userType: sessionStorage.getItem('userType') ||
                        localStorage.getItem('userType') ||
                        window.userType ||
                        'student',
                    email: sessionStorage.getItem('email') ||
                        localStorage.getItem('email') ||
                        window.email ||
                        'demo@ehb.be'
                };

                console.log('üë§ Current password user:', window.currentPasswordUser);
            } catch (error) {
                console.error('Error getting current user:', error);
                window.currentPasswordUser = {
                    gebruikersId: 'demo-user',
                    userType: 'student',
                    email: 'demo@ehb.be'
                };
            }
        }

        // === PASSWORD CHANGE API ===
        async function changePassword() {
            console.log('üîÑ Starting password change process...');

            const currentPassword = document.getElementById('currentPassword')?.value;
            const newPassword = document.getElementById('newPassword')?.value;
            const confirmPassword = document.getElementById('confirmPassword')?.value;

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showPasswordMessage('Wachtwoorden komen niet overeen', 'error');
                return;
            }

            // Validate strength
            if (!updatePasswordStrength(newPassword)) {
                showPasswordMessage('Nieuw wachtwoord voldoet niet aan alle beveiligingseisen', 'error');
                return;
            }

            // Show loading state
            const saveBtn = document.getElementById('savePasswordBtn');
            if (!saveBtn) return;

            const originalContent = saveBtn.innerHTML;
            saveBtn.innerHTML = '<div class="loading-spinner"></div> Bezig met opslaan...';
            saveBtn.disabled = true;

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        gebruikersId: window.currentPasswordUser?.gebruikersId,
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showPasswordMessage('Wachtwoord succesvol gewijzigd! üéâ', 'success');

                    // Show notification if available
                    if (typeof showNotification === 'function') {
                        showNotification('Wachtwoord succesvol gewijzigd', 'success');
                    }

                    // Close modal after 2 seconds
                    setTimeout(() => {
                        window.closePasswordModal();
                    }, 2000);
                } else {
                    showPasswordMessage(result.message || 'Er ging iets mis bij het wijzigen van het wachtwoord', 'error');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showPasswordMessage('Netwerkfout: Kan geen verbinding maken met de server', 'error');
            } finally {
                // Restore button
                if (saveBtn) {
                    saveBtn.innerHTML = originalContent;
                    saveBtn.disabled = false;
                    validatePasswordForm();
                }
            }
        }

        // === MESSAGE DISPLAY ===
        function showPasswordMessage(message, type = 'info') {
            const messageContainer = document.getElementById('modalMessage');
            if (!messageContainer) return;

            const className = type === 'error' ? 'error-message' : 'success-message';
            const icon = type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';

            messageContainer.innerHTML = `
        <div class="${className}">
            <i class="${icon}"></i>
            ${message}
        </div>
    `;

            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    messageContainer.innerHTML = '';
                }, 5000);
            }
        }

        // === EVENT LISTENERS SETUP ===
        function setupPasswordModalEventListeners() {
            console.log('üîß Setting up password modal event listeners...');

            // Password input event listeners
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const currentPasswordInput = document.getElementById('currentPassword');

            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function () {
                    updatePasswordStrength(this.value);
                    validatePasswordForm();
                });
                console.log('‚úÖ New password input listener attached');
            }

            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', validatePasswordForm);
                console.log('‚úÖ Confirm password input listener attached');
            }

            if (currentPasswordInput) {
                currentPasswordInput.addEventListener('input', validatePasswordForm);
                console.log('‚úÖ Current password input listener attached');
            }

            // Save button click
            const saveBtn = document.getElementById('savePasswordBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', changePassword);
                console.log('‚úÖ Save button listener attached');
            }

            // Form submit prevention
            const form = document.getElementById('passwordChangeForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    if (validatePasswordForm()) {
                        changePassword();
                    }
                });
                console.log('‚úÖ Form submit listener attached');
            }

            // Close modal on outside click
            const modal = document.getElementById('passwordModal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        window.closePasswordModal();
                    }
                });
                console.log('‚úÖ Modal outside click listener attached');
            }

            // Escape key to close modal
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('passwordModal');
                    if (modal && modal.style.display === 'block') {
                        window.closePasswordModal();
                    }
                }
            });
            console.log('‚úÖ Escape key listener attached');
        }

        // === AUTO-CONNECT EXISTING BUTTONS ===
        function connectExistingPasswordButtons() {
            console.log('üîó Connecting existing password buttons...');

            // Find all buttons that might be password change buttons
            const buttons = document.querySelectorAll('button, .ehbBtn');
            let connectedCount = 0;

            buttons.forEach((button, index) => {
                const buttonText = button.textContent || button.innerText || '';
                const buttonHTML = button.innerHTML || '';

                // Check if this is a password change button
                if ((buttonText.includes('Wachtwoord') && buttonText.includes('Wijzigen')) ||
                    buttonHTML.includes('fa-key') ||
                    buttonText.includes('Password') ||
                    button.classList.contains('password-btn')) {

                    // Remove any existing onclick handlers that might cause conflicts
                    button.removeAttribute('onclick');

                    // Add new event listener
                    button.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üîê Password button clicked:', button);
                        window.openPasswordModal();
                    });

                    // Also set onclick as backup
                    button.onclick = function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.openPasswordModal();
                    };

                    connectedCount++;
                    console.log(`‚úÖ Connected password button ${connectedCount}:`, button);
                }
            });

            console.log(`üéØ Total password buttons connected: ${connectedCount}`);
        }

        // === INITIALIZATION ===
        function initializePasswordModal() {
            console.log('üöÄ Initializing Password Modal System...');

            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function () {
                    setupPasswordModalEventListeners();
                    connectExistingPasswordButtons();
                });
            } else {
                setupPasswordModalEventListeners();
                connectExistingPasswordButtons();
            }

            // Also run after a short delay to catch any dynamically loaded content
            setTimeout(() => {
                connectExistingPasswordButtons();
            }, 1000);

            console.log('‚úÖ Password Modal System initialized successfully');
        }

        // === EXPORT FOR TESTING ===
        window.passwordModalSystem = {
            openModal: window.openPasswordModal,
            closeModal: window.closePasswordModal,
            toggleVisibility: window.togglePasswordVisibility,
            validateForm: validatePasswordForm,
            changePassword: changePassword,
            connectButtons: connectExistingPasswordButtons
        };

        // Auto-initialize when script loads
        initializePasswordModal();

        console.log('üîê Fixed Password Modal System loaded successfully!');
    </script>

    <script type="module" src="/src/JS/UTILS/startPage.js"></script>
    <script type="module" src="/src/JS/ACCOUNT/gegevens-qol.js"></script>
    <script type="module" src="/src/JS/STUDENTEN/gegevens-student.js"></script>
</body>

</html>